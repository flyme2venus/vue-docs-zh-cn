name: Windows Build

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - '.vitepress/**'
      - 'src-tauri/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - '.vitepress/**'
      - 'src-tauri/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  quick-build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9

    - name: Get pnpm store directory
      id: pnpm-cache
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: x86_64-pc-windows-msvc

    - name: Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'

    - name: Install frontend dependencies
      run: pnpm install --frozen-lockfile

    - name: Build frontend
      run: pnpm build

    - name: Verify frontend build
      run: |
        if (!(Test-Path ".vitepress/dist")) {
          Write-Error "Frontend build failed - dist directory not found"
          exit 1
        }
        $files = Get-ChildItem ".vitepress/dist" -Recurse | Measure-Object
        Write-Host "Frontend build successful - $($files.Count) files generated"

    - name: Build Tauri executable (no bundle)
      run: |
        echo "Building Windows executable with Vue icon..."
        pnpm tauri build --target x86_64-pc-windows-msvc --no-bundle
        
        if (Test-Path "src-tauri/target/x86_64-pc-windows-msvc/release/vue-docs-zh-cn.exe") {
          Write-Host "âœ“ Executable build successful"
          $size = (Get-Item "src-tauri/target/x86_64-pc-windows-msvc/release/vue-docs-zh-cn.exe").Length
          Write-Host "Executable size: $([math]::Round($size/1MB, 2)) MB"
          
          # éªŒè¯å›¾æ ‡æ˜¯å¦åµŒå…¥ï¼ˆé€šè¿‡æ–‡ä»¶å¤§å°ç²—ç•¥åˆ¤æ–­ï¼‰
          if ($size -gt 10MB) {
            Write-Host "âœ“ Icon likely embedded (larger file size)"
          } else {
            Write-Host "âš  Warning: File size seems small, icon may not be embedded"
          }
        } else {
          Write-Error "Executable build failed"
          exit 1
        }

    - name: Build Tauri with NSIS installer
      run: |
        echo "Building NSIS installer with Vue icon..."
        pnpm tauri build --target x86_64-pc-windows-msvc --bundles nsis
        
        $nsisPath = "src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis"
        if (Test-Path $nsisPath) {
          $installer = Get-ChildItem "$nsisPath/*.exe" | Select-Object -First 1
          if ($installer) {
            Write-Host "âœ“ NSIS installer created: $($installer.Name)"
            Write-Host "Installer size: $([math]::Round($installer.Length/1MB, 2)) MB"
          }
        } else {
          Write-Host "âš  NSIS installer not created (continuing with executable only)"
        }
      continue-on-error: true

    - name: Create portable package
      run: |
        $sourceExe = "src-tauri/target/x86_64-pc-windows-msvc/release/vue-docs-zh-cn.exe"
        $portableDir = "vue-docs-portable"
        
        # åˆ›å»ºä¾¿æºç‰ˆç›®å½•
        New-Item -ItemType Directory -Path $portableDir -Force
        Copy-Item $sourceExe "$portableDir/Vueæ–‡æ¡£.exe"
        
        # åˆ›å»ºè¯´æ˜Žæ–‡ä»¶
        @'
Vue.js ä¸­æ–‡æ–‡æ¡£æ¡Œé¢åº”ç”¨ - ä¾¿æºç‰ˆ

ä½¿ç”¨è¯´æ˜Žï¼š
1. åŒå‡» "Vueæ–‡æ¡£.exe" å¯åŠ¨åº”ç”¨
2. é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦å‡ ç§’é’ŸåŠ è½½
3. æ”¯æŒç¦»çº¿è®¿é—®å®Œæ•´çš„Vue.jsä¸­æ–‡æ–‡æ¡£

ç‰ˆæœ¬ä¿¡æ¯ï¼š
- æž„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- æž„å»ºç‰ˆæœ¬: ${{ github.sha }}
- ç³»ç»Ÿè¦æ±‚: Windows 10 1903+ (64ä½)

é¡¹ç›®åœ°å€: https://github.com/vuejs-translations/docs-zh-cn
'@ | Out-File -FilePath "$portableDir/README.txt" -Encoding UTF8
        
        # åŽ‹ç¼©ä¾¿æºç‰ˆ
        Compress-Archive -Path "$portableDir/*" -DestinationPath "vue-docs-portable-${{ github.sha }}.zip"
        
        Write-Host "âœ“ Portable package created"

    - name: Upload executable and installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-build-${{ github.sha }}
        path: |
          src-tauri/target/x86_64-pc-windows-msvc/release/vue-docs-zh-cn.exe
          src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
        retention-days: 30

    - name: Upload portable package
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable-${{ github.sha }}
        path: vue-docs-portable-${{ github.sha }}.zip
        retention-days: 30

    - name: Build summary
      run: |
        echo "## ðŸŽ‰ æž„å»ºå®Œæˆ" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $env:GITHUB_STEP_SUMMARY
        echo "- **å¯æ‰§è¡Œæ–‡ä»¶**: vue-docs-zh-cn.exe (å«Vueå›¾æ ‡)" >> $env:GITHUB_STEP_SUMMARY
        echo "- **NSISå®‰è£…ç¨‹åº**: Vue Docs_x.x.x_x64-setup.exe (å¦‚æžœæž„å»ºæˆåŠŸ)" >> $env:GITHUB_STEP_SUMMARY
        echo "- **ä¾¿æºç‰ˆ**: vue-docs-portable-${{ github.sha }}.zip" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½æ–¹å¼" >> $env:GITHUB_STEP_SUMMARY
        echo "åœ¨ Actions é¡µé¢çš„ Artifacts éƒ¨åˆ†ä¸‹è½½æž„å»ºæ–‡ä»¶" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### âœ¨ æ›´æ–°å†…å®¹" >> $env:GITHUB_STEP_SUMMARY
        echo "- å¯æ‰§è¡Œæ–‡ä»¶çŽ°åœ¨åŒ…å«Vue.jså®˜æ–¹å›¾æ ‡" >> $env:GITHUB_STEP_SUMMARY
        echo "- ä»…åœ¨Windowså¹³å°æž„å»ºï¼Œæé«˜æ•ˆçŽ‡" >> $env:GITHUB_STEP_SUMMARY
