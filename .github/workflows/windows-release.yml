name: Windows Release Build

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9

    - name: Get pnpm store directory
      id: pnpm-cache
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: x86_64-pc-windows-msvc

    - name: Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'

    - name: Install frontend dependencies
      run: pnpm install --frozen-lockfile

    - name: Lint frontend code
      run: pnpm type
      continue-on-error: true

    - name: Build frontend
      run: pnpm build

    - name: Verify frontend build
      run: |
        if (!(Test-Path ".vitepress/dist")) {
          Write-Error "Frontend build failed - dist directory not found"
          exit 1
        }
        Write-Host "Frontend build successful"

    - name: Build Tauri app
      uses: tauri-apps/tauri-action@v0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # å¦‚æœéœ€è¦ä»£ç ç­¾åï¼Œæ·»åŠ ä»¥ä¸‹ç¯å¢ƒå˜é‡
        # TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        # TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
      with:
        tagName: ${{ github.event.inputs.release_tag || github.ref_name }}
        releaseName: 'Vue Docs Desktop ${{ github.event.inputs.release_tag || github.ref_name }}'
        releaseBody: |
          # Vue.js ä¸­æ–‡æ–‡æ¡£æ¡Œé¢åº”ç”¨ ${{ github.event.inputs.release_tag || github.ref_name }}
          
          ## ğŸ“¦ Windows å®‰è£…åŒ…
          
          ### å®‰è£…è¯´æ˜
          1. ä¸‹è½½ `.msi` å®‰è£…ç¨‹åº
          2. è¿è¡Œå®‰è£…ç¨‹åºï¼ŒæŒ‰ç…§æç¤ºå®Œæˆå®‰è£…
          3. åœ¨å¼€å§‹èœå•ä¸­æ‰¾åˆ° "Vue Docs" å¹¶å¯åŠ¨
          
          ### åº”ç”¨ç‰¹æ€§
          - ğŸ–¥ï¸ åŸç”Ÿ Windows æ¡Œé¢ä½“éªŒ
          - ğŸ“– å®Œæ•´çš„ Vue.js ä¸­æ–‡æ–‡æ¡£ç¦»çº¿è®¿é—®
          - ğŸ” å¼ºå¤§çš„å†…ç½®æœç´¢åŠŸèƒ½
          - ğŸ“± å“åº”å¼è®¾è®¡ï¼Œé€‚é…ä¸åŒå±å¹•å°ºå¯¸
          - âš¡ å¿«é€Ÿå¯åŠ¨å’Œæµç•…å¯¼èˆª
          - ğŸŒ™ æ”¯æŒæ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢
          - ğŸ”„ è‡ªåŠ¨æ›´æ–°æ£€æŸ¥ï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰
          
          ### ç³»ç»Ÿè¦æ±‚
          - Windows 10 1903 æˆ–æ›´é«˜ç‰ˆæœ¬
          - 64ä½æ“ä½œç³»ç»Ÿ
          - æœ€å° 4GB å†…å­˜æ¨è
          
          ### æ–‡ä»¶è¯´æ˜
          - `Vue Docs_x.x.x_x64.msi` - Windows å®‰è£…ç¨‹åºï¼ˆæ¨èï¼‰
          - `vue-docs-zh-cn.exe` - ä¾¿æºç‰ˆå¯æ‰§è¡Œæ–‡ä»¶
          
          å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ GitHub Issues ä¸­åé¦ˆã€‚
        releaseDraft: false
        prerelease: false
        args: --target x86_64-pc-windows-msvc

    - name: Compress portable executable
      run: |
        Compress-Archive -Path "src-tauri/target/x86_64-pc-windows-msvc/release/vue-docs-zh-cn.exe" -DestinationPath "vue-docs-portable-windows.zip"

    - name: Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: |
          src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
        retention-days: 90

    - name: Upload portable executable
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable
        path: vue-docs-portable-windows.zip
        retention-days: 90

    - name: Calculate checksums
      run: |
        $installerPath = Get-ChildItem "src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi" | Select-Object -First 1
        $portablePath = "vue-docs-portable-windows.zip"
        
        $installerHash = Get-FileHash $installerPath.FullName -Algorithm SHA256
        $portableHash = Get-FileHash $portablePath -Algorithm SHA256
        
        Write-Output "## æ–‡ä»¶æ ¡éªŒå’Œ (SHA256)" | Out-File -FilePath checksums.txt
        Write-Output "``````" | Out-File -FilePath checksums.txt -Append
        Write-Output "$($installerHash.Hash)  $($installerPath.Name)" | Out-File -FilePath checksums.txt -Append
        Write-Output "$($portableHash.Hash)  $portablePath" | Out-File -FilePath checksums.txt -Append
        Write-Output "``````" | Out-File -FilePath checksums.txt -Append

    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: checksums
        path: checksums.txt
        retention-days: 90
